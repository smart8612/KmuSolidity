<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>KMU Tree Funding</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <style type="text/css" media="screen,projection">
    /* Custom Stylesheet */
    /**
    * Use this file to override Materialize files so you can update
    * the core Materialize files in the future
    *
    * Made By MaterializeCSS.com
    */

    .icon-block {
      padding: 0 15px;
    }
    .icon-block .material-icons {
      font-size: inherit;
    }
  </style>
</head>
<body>
  <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="/index.html" class="brand-logo">KMU Tree Funding</a>
      <ul class="right hide-on-med-and-down">
        <li><a href="/index.html">Home</a></li>
      </ul>

      <ul id="nav-mobile" class="sidenav">
        <li><a href="/index.html">Home</a></li>
      </ul>
      <a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
    </div>
  </nav>

  <!-- Modal Structure For Create Fund -->
  <div id="modal1" class="modal">
    <div class="modal-content">
      <h4>Tree Fund 생성 마법사</h4>
      <p>새로운 Tree Fund를 생성합니다! 다음과 같은 정보를 입력해주세요!</p>
      <row>
      <div class="input-field col s6">
        <i class="material-icons prefix">mode_edit</i>
        <textarea id="newFundName" class="materialize-textarea"></textarea>
        <label for="icon_prefix2">이름</label>
      </div>
      </row>
      <row>
      <div class="input-field col s6">
        <i class="material-icons prefix">mode_edit</i>
        <textarea id="newFundDuration" class="materialize-textarea"></textarea>
        <label for="icon_prefix2">기간(초)</label>
      </div>
      </row>
      <row>
      <div class="input-field col s12">
        <i class="material-icons prefix">mode_edit</i>
        <textarea id="newFundGoal" class="materialize-textarea"></textarea>
        <label for="icon_prefix2">목표금액(wei)</label>
      </div>
      </row>
    </row>
    </div>
    <div class="modal-footer">
      <a class="modal-close waves-effect waves-green btn-flat">취소</a>
      <a class="modal-close waves-effect waves-green btn-flat" id="createNewFund">생성</a>
    </div>
  </div>

  <!-- Modal Structure For Fund -->
  <div id="modal2" class="modal">
    <div class="modal-content">
      <h4>금액을 입력해주세요!</h4>
      <p>단위는 Wei 입니다</p>
      <div class="row">
        <div class="input-field col s12">
          <input disabled value="I am not editable" id="fundIdField" type="text" class="validate">
          <label for="disabled">Fund Id</label>
        </div>
        <div class="input-field col s12">
          <i class="material-icons prefix">mode_edit</i>
          <textarea id="weiInputField" class="materialize-textarea"></textarea>
          <label for="icon_prefix2">Wei</label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <a class="modal-close waves-effect waves-green btn-flat">취소하기</a>
      <a id="execFundBtn" class="modal-close waves-effect waves-green btn-flat">투자하기</a>
    </div>
  </div>

  <!-- Card Somponent For Write Funding Info -->
  <div class="col s12 m4" id="newFundCard" style="display: none;" >
    <div class="card blue-grey darken-1">
      <div class="card-content white-text">
        <span class="card-title">Card Title</span>
        <ul id='fundInfolist_' >
          투자자 수: <li>one</li>
          마감 시한: <li>two</li>
          상태 정보: <li>three</li>
          마감 여부: <li>dsa</li>
          목표 금액: <li>four</li>
          현 모금액: <li>five</li>
        </ul>
      </div>
      <div class="card-action">
        <a >투자하기</a>
        <a >검사하기</a>
      </div>
    </div>
  </div>


  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <h1 class="header center orange-text">Metamask를 통해 로그인하세요!</h1>
      <div class="row center">
        <h5 class="header col s12 light" id="loginResultBox">로그인에 성공하면 이곳에 계정 주소가 표시됩니다</h5>
      </div>
      <div class="row center">
        <a class="waves-effect waves-light btn-large" id="connetMetaMaskBtn">연동하기</a>
      </div>
      <br><br>

    </div>
  </div>


  <div class="container">
    <div class="section" id="cardViewLayout">
      <!--   card Section   -->
      <div class="row" id="cardsRow_0"></div>
    </div>
    <br><br>
  </div>

  <footer class="page-footer orange">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">Company Bio</h5>
          <p class="grey-text text-lighten-4">We are a team of college students working on this project like it's our full time job. Any amount would help support and continue development on this project and is greatly appreciated.</p>


        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Settings</h5>
          <ul>
            <li><a class="white-text" href="#!">Link 1</a></li>
            <li><a class="white-text" href="#!">Link 2</a></li>
            <li><a class="white-text" href="#!">Link 3</a></li>
            <li><a class="white-text" href="#!">Link 4</a></li>
          </ul>
        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Connect</h5>
          <ul>
            <li><a class="white-text" href="#!">Link 1</a></li>
            <li><a class="white-text" href="#!">Link 2</a></li>
            <li><a class="white-text" href="#!">Link 3</a></li>
            <li><a class="white-text" href="#!">Link 4</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Made by <a class="orange-text text-lighten-3" href="http://materializecss.com">Materialize</a>
      </div>
    </div>
  </footer>


  <!--  Scripts -->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src='node_modules/web3/dist/web3.min.js'></script>
  <script>
  var accounts = null;
  var contractInstance = null;
  var address = '0x06E16f12DBFBB71ccb5eAf937899Ed02c0281C92';
  var abiobj = [
	{
		"constant": false,
		"inputs": [
			{
				"name": "_fundId",
				"type": "uint256"
			}
		],
		"name": "checkGoalReached",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_name",
				"type": "string"
			},
			{
				"name": "_duration",
				"type": "uint256"
			},
			{
				"name": "_goalAmount",
				"type": "uint256"
			}
		],
		"name": "createSmartTreeFunding",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_fundId",
				"type": "uint256"
			}
		],
		"name": "fund",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"name": "_name",
				"type": "string"
			},
			{
				"name": "_duration",
				"type": "uint256"
			},
			{
				"name": "_goalAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "treeId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "duration",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "goalAmount",
				"type": "uint256"
			}
		],
		"name": "NewTreeFund",
		"type": "event"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "funds",
		"outputs": [
			{
				"name": "name",
				"type": "string"
			},
			{
				"name": "numInvestors",
				"type": "uint256"
			},
			{
				"name": "deadline",
				"type": "uint256"
			},
			{
				"name": "status",
				"type": "string"
			},
			{
				"name": "ended",
				"type": "bool"
			},
			{
				"name": "goalAmount",
				"type": "uint256"
			},
			{
				"name": "totalAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "fundsToInvestors",
		"outputs": [
			{
				"name": "addr",
				"type": "address"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "fundsToOwner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getFundsCount",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
];

  async function createNewTreeFund() {
    if (contractInstance != null) {
      try {
          let _name = $('#newFundName').val();
          let _duration = $('#newFundDuration').val();
          let _goalAmount =  $('#newFundGoal').val();
          let value1 = await contractInstance.methods['createSmartTreeFunding(string,uint256,uint256)'](_name, _duration, _goalAmount).send({from:accounts[0]});

      } catch (error) {
        alert("Transaction 생성중 문제가 발생되었습니다!");
        console.log(error);
      }
    }
  }

  // Fund Card에서 투자하기 버튼을 클릭하면 호출되는 콜백함수
  function fundToFundung(id) {
    $('#fundIdField').val(id);
    $('#modal2').modal('open');
    
  }

  async function renderFundCard(card, id) {
      let fund = await contractInstance.methods['funds(uint256)'](id).call();

      card.attr("id", "fundCard_"+(id));
      card.attr("style", "");

      let cardContents = card.children().children();
      let title = cardContents.children()[0];
      let ulist = cardContents.children()[1]
      let lists = $(ulist).children();

      let fundBtn = $(cardContents[1]).children()[0];

      $(title).text(fund["name"]);
      $(ulist).attr("id", "fundInfolist_"+(id));
      $(fundBtn).attr("onclick", "fundToFundung(" + id + ")");

      for (var i=0; i<lists.length; i++) {
        let each = lists[i];
        $(each).text(fund[i+1]);
      }

  }

  async function cloneFundCard() {
    let fundCnt = await contractInstance.methods['getFundsCount']().call();
    
    let cards = $('#cardsRow_0');
    for (var i=0; i<fundCnt; i++) {
      let tmpCard = $('#newFundCard').clone();
      renderFundCard(tmpCard, i);
      cards.append(tmpCard);
    }
  }

  (function($){
    $(window).load(async () => {
      if (window.ethereum) {
        window.web3 = new Web3(window.ethereum);
        contractInstance = await new window.web3.eth.Contract(abiobj, address);
        cloneFundCard();

      } else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);

      } else {
        window.alert('Non-Ethereum browser detected. You should consider trying MetaMask!');

      }
    });

    $(document).ready(function() {
      $('.modal').modal({
		    dismissible: false,
        onCloseEnd: () => {
          $('#newFundName').val(null);
          $('#newFundDuration').val(null);
          $('#newFundGoal').val(null);
          $('#weiInputField').val(null);
          $('#fundIdField').val(null);
        }
	    });
      $('.sidenav').sidenav();

      $('#createNewFund').click(async () => {
        createNewTreeFund();
        $('#modal1').modal('close');

      });
      
      $('#execFundBtn').click(async () => {
        window.accounts = await ethereum.request({ method: 'eth_requestAccounts' });

        try {
          let cardFundId = $('#fundIdField').val();
          let weiAmount = $('#weiInputField').val();
          
          if (contractInstance != null) {
            console.log(contractInstance.methods);
            let value1 = await contractInstance.methods['fund(uint256)'](cardFundId).send({
              from:accounts[0],
              value: Number(weiAmount)
            });
            console.log(value1);
          }

        } catch (error) {
          alert("Transaction 생성중 문제가 발생되었습니다!");
          console.log(error);
        }

        $('#modal2').modal('close');

      });

      $('#connetMetaMaskBtn').click(async () => {
        window.accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        
        if (window.accounts[0] != $('#loginResultBox').text()) {
	        $('#loginResultBox').text(window.accounts[0]);
          $('#connetMetaMaskBtn').text("Fund 생성하기");
          $('#connetMetaMaskBtn').attr('href', '#');
          
        } else {
          $('#modal1').modal('open');

        }
        
      });

    });
  })(jQuery); // end of jQuery name space
  </script>
  
  </body>
</html>
